---
layout: post
title: "Erste Github Action: Mastodon"
description: >
  Wie automatisiert ein Mastodon-Post erstellt wird, wenn ich einen Blog-Post schreibe.
---

Wenn ich schon Github Pages teste, muss ich auch gleich die [Github Actions](https://github.com/features/actions) mit ausprobieren.
Das Versprechen ist, dass ich für jeden Push automatisiert eine Aktion auslösen kann.
Das möchte ich als erstes für Mastodon-Posts testen, mithilfe [dieser Vorlage](https://github.com/cbrgm/mastodon-github-action).

Dafür habe ich in meinem Mastodon-Account eine neue *Anwendung* angelegt (`/settings/applications/new`):
> **Name**: Github Action

> **Website**: https://github.com/

und habe ihr Schreibrechte gegeben.

Die URL und den Access Token werden dann als [Secrets](https://docs.github.com/de/actions/security-for-github-actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository) in Github gespeichert.

> Hauptseite des Repositorys > Einstellungen > Geheimnisse und Variablen > Actions

Dort dann `https://bildung.social/` als MASTODON_URL und den Access Token als MASTODON_ACCESS_TOKEN anlegen.

## Github Actions
Hier wurde es komplizierter, weil das Anpassen einer *Action* schlecht dokumentiert ist. Deshalb habe ich nicht die vorhandene einfach um meine Action erweitern können, sondern habe eine neue angelegt.

> Reiter *Actions* in der Repository-Ansicht > New Workflow

```yml
name: Blog2Masto
on:
  push:
    paths:
      - '_posts/*.md'
jobs:
  post:
    runs-on: ubuntu-latest
    steps:
    - name: Check out this repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Identify Added Blog Post
      id: identify_added_blog_post
      run: |
        sha=${{ github.sha }}

        post_file=$(git diff --name-only --diff-filter=A $sha)
        if [ -n "$post_file" ]; then
          new_post_file=$(echo "$post_file" | head -n 1)

          title=$(awk '/^title:/ {$1=""; sub(/^[ \t]+/, ""); print}' "$new_post_file" | tr -d '"')
          date=$(echo "$new_post_file" | grep -oP '\d{4}-\d{2}-\d{2}' | sed 's/-/\//g')
          tags=$(awk '/^tags:/ {for (i=2; i<=NF; i++) print "#" $i}' "$new_post_file" | tr -d '[,]' | tr '\n' ' ')

          base_url="${{ secrets.BLOG_URL }}"
          url=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr -d '[:punct:]' | sed -E 's/[[:space:]]+/-/g' | sed -E 's/^-//;s/-$//')
          post_url="$base_url/$date/$url"

          echo "post_title=$title" >> $GITHUB_ENV
          echo "post_url=$post_url" >> $GITHUB_ENV
          echo "post_tags=$tags" >> $GITHUB_ENV
        fi
    - name: Post to Mastodon
      id: mastodon
      if: env.post_title != '' && env.post_url != ''
      uses: cbrgm/mastodon-github-action@v2
      with:
        access-token: ${{ secrets.MASTODON_ACCESS_TOKEN }}
        url: ${{ secrets.MASTODON_URL }}
        message: |
          "${{ env.post_title }}"
          ${{ env.post_url }}

          ${{ env.post_tags }} #FediLZ
```

[Quelle für die Action-Basis](https://github.com/cbrgm/mastodon-github-action/tree/main) und das [Auslesen der Informationen aus dem Commit](https://michaelchadwick.info/blog/2023/11/17/share-new-jekyll-blog-post-on-mastodon-using-github-actions/)

Bei `runs-on: ubuntu-latest` war ich misstrauisch, bis ich [nachgelesen habe](https://docs.github.com/de/actions/writing-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on),
dass damit der job auf einer github-hosted virtual machine ausgeführt wird.

Die Vorlage aus der 2. Quelle ist besser kommentiert als meine Variante, aber sie ist unvollständig (Die `post_file` Zeile fehlt).
Ansonsten habe ich die `uses``-Zeilen aktualisiert, das Post-Schema angepasst (#FediLZ steht für das deutsche Fediverse-Lehrerzimmer), etc.
